<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Loco.Engineering Decoder Settings</title>

    <link rel="stylesheet" href="./base-min.css">
    <link rel="stylesheet" href="./grids-min.css">
    <link rel="stylesheet" href="./grids-responsive-min.css">
    <script type="module" src="./action-modal.js"></script>

    <style>
        * {
            font-family: courier;
        }

        h1 {
            text-align: center;
            margin-left: auto;
            margin-right: auto;
            padding-top: 40px;
            padding-bottom: 20px;
            max-width: 620px;

            font-size: 25px;
            font-weight: 800;
        }

        .section_header {
            margin-bottom: 5px;
            font-size: 16px;
            font-weight: 900;
        }

        .section_hint {
            font-size: 13px;
            font-weight: 300;
            margin-bottom: 35px;
        }

        .no_data_hint {
            font-size: 13px;
            font-weight: 300;
            text-align: center;
            margin-top: 30px;
        }

        a {
            text-decoration: none;
        }

        input[type=text],
        select {
            width: 100%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .wifi_set_cont {
            border-radius: 20px;
            background-color: #f2f2f2;
            padding: 40px;
            max-width: 820px;
            margin-left: auto;
            margin-right: auto;
            margin-top: 30px;
            text-align: left;
        }

        .s_wifi {
            width: 160px;
            border-radius: 20px;
            height: 30px;
            margin-left: auto;
            margin-right: auto;
            color: white;
            border-style: none;
            background-color: black;
            font-weight: 700;
            display: block;
            margin-top: 30px;
            font-size: 12px;
            margin-left: 10px;</div>
            margin-right: 10px;
        }

        .s_wifi:hover {
            cursor: pointer;
        }

        .new_btn {
            width: 100px;
            border-radius: 20px;
            height: 25px;
            line-height: 25px;
            color: black;
            border-style: none;
            background-color: #e9c46a;
            font-weight: 700;
            margin-left: 20px;
            font-size: 11px;

        }

        .new_btn:hover {
            cursor: pointer;
        }

        .new_action_btn {
            margin-left: 5px;
        }


        .table_btn {
            width: 160px;
            border-radius: 20px;
            height: 30px;
            margin-left: auto;
            margin-right: auto;
            color: white;
            border-style: none;
            background-color: black;
            font-weight: 700;
            display: block;
            font-size: 12px;
        }

        .table_btn:hover {
            cursor: pointer;
        }

        .hint {
            margin-bottom: 10px;
        }



        .common_table {
            border-collapse: collapse;
            width: 100%;
            max-height: 400px;
        }

        .common_table td,
        #common_table th {
            padding-left: 5px;
            padding-right: 5px;
        }

        .common_table td {
            font-size: 14px;
            font-weight: 400;
        }

        .common_table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .add_output_value_cell {
            background-color: #fff;
        }

        .common_table tr:hover {
            background-color: #eeeeee;
            cursor: pointer;
        }

        .common_table th {
            padding-top: 12px;
            padding-bottom: 12px;
            text-align: left;
            color: #000;
            font-size: 12px;
            font-weight: 700;
            padding-left: 5px;
            padding-right: 5px;
            background-color: #eeeeee;
        }

        .tableFixHead {
            overflow-y: auto;
            /* make the table scrollable if height is more than 200 px  */
            max-height: 300px;
            /* gives an initial height of 200px to the table */
        }

        .tableFixHead thead th {
            position: sticky;
            /* make the table heads sticky */
            top: 0px;
            /* table head will be placed from the top of the table and sticks to it */
        }

        /*Modal*/
/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: #fdfdfd;
  margin: 10% auto; /* 15% from the top and centered */
  padding-top: 30px;
  padding-bottom: 30px;
  padding-left: 20px;
  padding-right: 20px;
  min-width: 350px; /* Could be more or less, depending on screen size */
  max-width: 400px; /* Could be more or less, depending on screen size */
  border-radius: 10px;
}

.modal-content-container {
  max-width: 350px;
  min-width: 300px;

  margin-left: auto;
  margin-right: auto;
}


/* The Close Button */
.modal-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.modal-close:hover,
.modal-close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}


/*Switcher*/

.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 28px;
  margin-bottom: 5px;
  margin-top: 5px;
}

.switch input { 
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 20px;
  width: 20px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
}

input:checked + .slider {
  background-color: #2a9d8f;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2a9d8f;
}

input:checked + .slider:before {
  -webkit-transform: translateX(30px);
  -ms-transform: translateX(30px);
  transform: translateX(30px);
}

/* Rounded sliders */
.slider.round {
  border-radius: 28px;
}

.slider.round:before {
  border-radius: 50%;
}

/*New action modal*/
.action_modal_title {
    display: block;
    padding-top: 25px;
            font-size: 16px;
            font-weight: 900;
        }

        .output_values_table{
            margin-top: 10px;
        }

    </style>
</head>

<body>
    <h1>Wireless Command Control (WCC)/SimpleDCC Decoder Settings</h1>

    <div class="wifi_set_cont">
        <h3 class="section_header">Settings</h3>
        <p class="section_hint">Type in a decoder address that you want to use with this decoder.
            It should be the same address as you use to send DCC commands from your command station to this decoder. For
            example, 2 or 5 or 110, etc.
            <br>
            <br>
            Press on "Skip" if you want to see all DCC packets in the list below or you don't use DCC.
        </p>
        <input type="text" id="ssid" placeholder="Decoder address, for example, 2 or 5 or 122 etc">
        <div style="display: flex; width:300px; margin: auto;"><button id="s_wifi" class="s_wifi">Save</button>
        <button id="s_wifi" class="s_wifi">Hide</button></div>
    </div>

    <div class="wifi_set_cont">
        <h3 class="section_header">Actions<button id="new_action_btn" class="new_btn">Add action</button>
        </h3>

        <p class="section_hint">What the decoder should do when a particular DCC packet or WCC message is received</p>
        <div class="tableFixHead">

            <table id="dcc_packets" class="common_table">
                <thead>
                    <tr>
                        <th width="40">ADDRESS</th>
                        <th width="100">TYPE</th>
                        <th>DESCRIPTION</th>
                        <th width="100">RAW PACKET</th>
                        <th width="80"></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>

            </table>
        </div>
    </div>

    <div class="wifi_set_cont">
        <h3 class="section_header">DCC packets</h3>
        <p class="section_hint">DCC packets filtered by the decoder address or all DCC packets received by the decoder
            if the decoder address isn't specified</p>

        <div class="tableFixHead" id="dcc_packets_table_container">

            <table id="dcc_packets_table" class="common_table">
                <thead>
                    <tr>
                        <th width="40">ADDRESS</th>
                        <th width="100">TYPE</th>
                        <th>DESCRIPTION</th>
                        <th width="100">RAW PACKET</th>
                        <th width="80"></th>
                    </tr>
                </thead>
                <tbody id="dcc_packets_tbody">
                </tbody>

            </table>
            <p class="no_data_hint" id="no_dcc_packets_hint">No DCC packets received yet</p>

        </div>
    </div>


    <div class="wifi_set_cont">
        <h3 class="section_header">WCC events</h3>
        <p class="section_hint">Messages received from other decoders over WCC protocol</p>

        <div class="tableFixHead">

            <table id="dcc_packets" class="common_table">
                <thead>
                    <tr>
                        <th width="40">ADDRESS</th>
                        <th width="100">TYPE</th>
                        <th>DESCRIPTION</th>
                        <th width="100">RAW PACKET</th>
                        <th width="80"></th>
                    </tr>
                </thead>
                <tbody>
                </tbody>

            </table>
        </div>

        <action-modal></action-modal>

    </div>

    <script type="module">
        import { show_new_action } from "./action-modal.js";

        //var gateway = `ws://${window.location.hostname}/ws`;
        var gateway = `ws://192.168.4.1/ws`;

        var outputs = [];

        outputs.push({name: "IO1", type:"IO"});
        outputs.push({name: "IO2", type:"IO"});
        outputs.push({name: "LED1", type:"LED"});
        outputs.push({name: "LED2", type:"LED"});
        outputs.push({name: "LED3", type:"LED"});
        outputs.push({name: "Speaker", type:"AUDIO"});

        var websocket;
        window.addEventListener('load', onLoad);
        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }
        function onOpen(event) {
            console.log('Connection opened');
        }
        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }
        async function onMessage(event) {

            const buffer = new Uint8Array(await event.data.arrayBuffer());
            console.log("New message " + buffer.length);

            //Parse the message from a decoder
            //Get a type
            var msg_index = 0;
            let msg_type = buffer[msg_index++];

            if (msg_type == 4) {
                //This a message with DCC packets
                //Get the amount of DCC packets
                let dcc_packets_amount = buffer[msg_index++];
                for (var i = 0; i < dcc_packets_amount; i++) {
                    let packet_type = buffer[msg_index++];
                    var packet_type_str = "Unknown";
                    var description_str = "";

                    let adr_1 = buffer[msg_index++];
                    let adr_2 = buffer[msg_index++];

                    let address = (((adr_2 & 0xFF) << 8) | (adr_1 & 0xFF));
                    let raw_packet_length = buffer[msg_index++];

                    var raw_packet = [];
                    var raw_packet_str = "";

                    for (var k = 0; k < raw_packet_length; k++) {
                        raw_packet[k] = buffer[msg_index++];
                        raw_packet_str += toBinString(Uint8Array.from([raw_packet[k]])) + " ";
                    }

                    let user_data_length = buffer[msg_index++];

                    var user_data = [];
                    for (var k = 0; k < user_data_length; k++) {
                        user_data[k] = buffer[msg_index++];

                    }

                    switch (packet_type) {
                        case 0:
                            description_str = "No description available";
                            address = "-";
                            break;
                        case 1:
                            packet_type_str = "Speed";
                            description_str = `Speed: ${user_data[0]} | Steps: ${user_data[2]} | Dir: ${user_data[1] ? 'Forward' : 'Reverse'}`
                            break;
                        case 2:
                            packet_type_str = "Function";
                            //Get the function group
                            var function_group_str = "0 - 4";
                            switch (user_data[0]) {
                                case 2:
                                    function_group_str = "5 - 8";
                                    break;
                                case 3:
                                    function_group_str = "9 - 12";
                                    break;
                                case 4:
                                    function_group_str = "13 - 20";
                                    break;
                                case 5:
                                    function_group_str = "21 - 28";
                                    break;
                                default:
                                    break;
                            }
                            description_str = `Function Group: ${function_group_str} | Steps: ${user_data[2]} | Dir: ${user_data[1] ? 'Forward' : 'Reverse'}`
                            break;
                        default:
                            break;
                    }

                    //Add a cell to the DCC packets list
                    var tr_node = document.createElement('tr');
                    tr_node.classList.add("service_cell");
                    tr_node.innerHTML = `<td>${address}</td><td>${packet_type_str}</td><td>${description_str}</td><td>${raw_packet_str}</td><td><button id="table_btn" class="table_btn">Add action</button></td>`;

                    document.querySelector('#dcc_packets_tbody').appendChild(tr_node);


                }

            }

            document.querySelector('#no_dcc_packets_hint').style.display = "none";

            //Autoscoll
            //let dcc_packets_table_el = document.querySelector('#dcc_packets_table_container');
            //dcc_packets_table_el.scrollTop = dcc_packets_table_el.scrollHeight;

        }
        function onLoad(event) {
            initWebSocket();
            initButton();
        }
        function initButton() {
            document.getElementById('s_wifi').addEventListener('click', connectToWiFi);
        }
        function connectToWiFi() {
            let ssid = document.getElementById('ssid').value;
            let passwd = document.getElementById('passwd').value;
            let msg_ind = 0;
            var wf_set = [];
            wf_set[msg_ind++] = 2; //message type
            wf_set[msg_ind++] = ssid.length; // ssid length
            for (let i = 0; i < ssid.length; ++i) {
                wf_set[msg_ind++] = ssid.charCodeAt(i);
            }
            wf_set[msg_ind++] = passwd.length; // passwd length
            for (let i = 0; i < passwd.length; ++i) {
                wf_set[msg_ind++] = passwd.charCodeAt(i);
            }
            let msg = new Uint8Array(wf_set);
            console.log(msg);
            websocket.send(msg);
        }

        document.getElementById("new_action_btn").onclick = () => {
                show_new_action(outputs);
            };

        const toBinString = (bytes) =>
            bytes.reduce((str, byte) => str + byte.toString(2).padStart(8, '0'), '');
    </script>
</body>

</html>